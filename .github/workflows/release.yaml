name: PyPI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:

  push:
    branches:
      - "trunk-*"
    tags:
      - "v*"

  workflow_dispatch:

jobs:
  build_wheel:
    name: Build wheel
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6
    - name: Set up Python
      uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
      with:
        python-version: 3.12
    - name: Set up Python environment
      uses: glotzerlab/workflows/setup-uv@5cfac9da9cb78e16ae97a9119b6fd13c1c2d6f5e # 0.1.0
      with:
        lockfile: ".github/workflows/requirements-build.txt"

    - name: Build wheel
      run: python3 -m build --outdir dist/ .

    - run: ls -lR dist
    # - uses: actions/upload-artifact@v4.3.3
    #   with:
    #     name: dist-python-${{ matrix.python.version }}-${{ matrix.os.base }}-${{ matrix.os.arch }}
    #     path: ./wheelhouse/*.whl

  # upload_pypi:
  #   name: Publish [PyPI]
  #   needs: [build_wheel]
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v4.1.7
  #       with:
  #         merge-multiple: 'true'
  #         pattern: dist-*
  #         path: dist

  #     - name: Check files
  #       run: ls -lR dist

  #     - name: Upload to PyPI
  #       # upload to PyPI on every tag starting with 'v'
  #       if: startsWith(github.ref, 'refs/tags/v')
  #       uses: pypa/gh-action-pypi-publish@v1.8.14
  #       with:
  #         user: __token__
  #         password: ${{ secrets.PYPI_API_TOKEN }}

  #     - name: Upload to TestPyPI
  #       # otherwise, upload to TestPyPi
  #       if: ${{ !startsWith(github.ref, 'refs/tags/v') && (github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && github.actor != 'dependabot[bot]')) }}
  #       uses: pypa/gh-action-pypi-publish@v1.8.14
  #       with:
  #         user: __token__
  #         password: ${{ secrets.TEST_PYPI_API_TOKEN }}
  #         repository-url: https://test.pypi.org/legacy/
  #         skip-existing: true
